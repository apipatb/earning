// Prisma Schema for EarnTrack
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum PlatformCategory {
  FREELANCE
  DELIVERY
  SERVICES
  OTHER
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum SaleStatus {
  COMPLETED
  PENDING
  CANCELLED
}

enum InventoryLogType {
  PURCHASE
  SALE
  ADJUSTMENT
  DAMAGE
  RETURN
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  BANK
  OTHER
}

// ============================================
// MODELS
// ============================================

model User {
  id           String     @id @default(uuid())
  email        String     @unique @db.VarChar(255)
  passwordHash String     @map("password_hash")
  name         String?
  timezone     String     @default("UTC")
  currency     String     @default("USD") @db.VarChar(3)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  platforms      Platform[]
  earnings       Earning[]
  goals          Goal[]
  products       Product[]
  sales          Sale[]
  inventoryLogs  InventoryLog[]
  customers      Customer[]
  expenses       Expense[]
  invoices       Invoice[]

  @@map("users")
}

model Platform {
  id           String             @id @default(uuid())
  userId       String             @map("user_id")
  name         String             @db.VarChar(100)
  category     PlatformCategory
  color        String?            @db.VarChar(7) // hex color
  expectedRate Decimal?           @map("expected_rate") @db.Decimal(10, 2)
  isActive     Boolean            @default(true) @map("is_active")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  earnings     Earning[]

  @@unique([userId, name])
  @@index([userId, isActive])
  @@map("platforms")
}

model Earning {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  platformId String   @map("platform_id")
  date       DateTime @db.Date
  hours      Decimal? @db.Decimal(5, 2)
  amount     Decimal  @db.Decimal(10, 2)
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform   Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@index([userId, date(sort: Desc)])
  @@index([platformId, date(sort: Desc)])
  @@map("earnings")
}

model Goal {
  id            String     @id @default(uuid())
  userId        String     @map("user_id")
  title         String     @db.VarChar(200)
  targetAmount  Decimal    @map("target_amount") @db.Decimal(10, 2)
  currentAmount Decimal    @default(0) @map("current_amount") @db.Decimal(10, 2)
  deadline      DateTime?  @map("deadline") @db.Date
  description   String?    @db.Text
  status        GoalStatus @default(ACTIVE)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@map("goals")
}

model Product {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  price        Decimal  @db.Decimal(10, 2)
  category     String?  @db.VarChar(100)
  sku          String?  @db.VarChar(100) // Stock Keeping Unit

  // Inventory tracking
  quantity     Decimal  @default(0) @db.Decimal(10, 2)
  reorderPoint Decimal  @default(10) @map("reorder_point") @db.Decimal(10, 2)
  supplierName String?  @map("supplier_name") @db.VarChar(255)
  supplierCost Decimal? @map("supplier_cost") @db.Decimal(10, 2)

  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sales        Sale[]
  inventoryLogs InventoryLog[]

  @@unique([userId, name])
  @@index([userId, isActive])
  @@map("products")
}

model Sale {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  productId    String     @map("product_id")
  quantity     Decimal    @db.Decimal(10, 2)
  unitPrice    Decimal    @map("unit_price") @db.Decimal(10, 2)
  totalAmount  Decimal    @map("total_amount") @db.Decimal(12, 2)
  saleDate     DateTime   @map("sale_date") @db.Date
  customer     String?    @db.VarChar(255)
  notes        String?    @db.Text
  status       SaleStatus @default(COMPLETED)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId, saleDate(sort: Desc)])
  @@index([productId, saleDate(sort: Desc)])
  @@index([userId, status])
  @@map("sales")
}

model InventoryLog {
  id              String             @id @default(uuid())
  userId          String             @map("user_id")
  productId       String             @map("product_id")
  quantityChange  Decimal            @map("quantity_change") @db.Decimal(10, 2)
  type            InventoryLogType
  notes           String?            @db.Text
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([productId, createdAt(sort: Desc)])
  @@map("inventory_logs")
}

model Customer {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  name           String   @db.VarChar(255)
  email          String?  @db.VarChar(255)
  phone          String?  @db.VarChar(20) // E.164 format recommended
  company        String?  @db.VarChar(255)
  address        String?  @db.Text
  city           String?  @db.VarChar(100)
  country        String?  @db.VarChar(100)

  // Customer metrics
  totalPurchases Decimal  @default(0) @map("total_purchases") @db.Decimal(12, 2)
  totalQuantity  Decimal  @default(0) @map("total_quantity") @db.Decimal(10, 2)
  purchaseCount  Int      @default(0) @map("purchase_count")
  lastPurchase   DateTime? @map("last_purchase")

  notes          String?  @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices       Invoice[]

  @@unique([userId, email])
  @@index([userId, isActive])
  @@map("customers")
}

model Expense {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  category        String   @db.VarChar(100)
  description     String   @db.Text
  amount          Decimal  @db.Decimal(10, 2)
  expenseDate     DateTime @map("expense_date") @db.Date

  // Expense details
  vendor          String?  @db.VarChar(255)
  isTaxDeductible Boolean  @default(false) @map("is_tax_deductible")
  receiptUrl      String?  @map("receipt_url") @db.Text

  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expenseDate(sort: Desc)])
  @@index([userId, category])
  @@map("expenses")
}

model Invoice {
  id             String         @id @default(uuid())
  userId         String         @map("user_id")
  customerId     String?        @map("customer_id")
  invoiceNumber  String         @map("invoice_number") @db.VarChar(100)

  // Invoice details
  subtotal       Decimal        @db.Decimal(12, 2)
  taxAmount      Decimal        @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount Decimal        @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal        @map("total_amount") @db.Decimal(12, 2)

  // Dates
  invoiceDate    DateTime       @map("invoice_date") @db.Date
  dueDate        DateTime       @map("due_date") @db.Date
  paidDate       DateTime?      @map("paid_date") @db.Date

  // Status
  status         InvoiceStatus  @default(DRAFT)
  paymentMethod  PaymentMethod? @map("payment_method")

  notes          String?        @db.Text
  terms          String?        @db.Text

  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer       Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  lineItems      InvoiceLineItem[]

  @@unique([userId, invoiceNumber])
  @@index([userId, invoiceDate(sort: Desc)])
  @@index([userId, status])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String  @id @default(uuid())
  invoiceId   String  @map("invoice_id")
  description String  @db.Text
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal @map("total_price") @db.Decimal(12, 2)

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_line_items")
}
