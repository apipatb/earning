// Prisma Schema for EarnTrack
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum PlatformCategory {
  FREELANCE
  DELIVERY
  SERVICES
  OTHER
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum SaleStatus {
  COMPLETED
  PENDING
  CANCELLED
}

enum InventoryLogType {
  PURCHASE
  SALE
  ADJUSTMENT
  DAMAGE
  RETURN
}

enum ForecastMethod {
  MOVING_AVG
  EXPONENTIAL
  LINEAR
}

enum AlertType {
  LOW_STOCK
  OVERSTOCK
  EXPIRING
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  BANK
  OTHER
}

enum FileSharePermission {
  VIEW
  EDIT
}

enum WebhookStatus {
  ACTIVE
  INACTIVE
}

enum WebhookEventType {
  EARNING_CREATED
  EARNING_UPDATED
  EARNING_DELETED
  INVOICE_CREATED
  INVOICE_SENT
  INVOICE_PAID
  INVOICE_OVERDUE
  SALE_CREATED
  SALE_UPDATED
  PRODUCT_LOW_STOCK
  CUSTOMER_CREATED
  EXPENSE_CREATED
  GOAL_COMPLETED
}

enum WhatsAppContactStatus {
  ACTIVE
  BLOCKED
}

enum WhatsAppMessageDirection {
  INBOUND
  OUTBOUND
}

enum WhatsAppMessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

enum IntegrationPlatform {
  ZAPIER
  MAKE
  SLACK
  TEAMS
}

enum SyncStatus {
  SUCCESS
  FAILED
  PENDING
}

// ============================================
// MODELS
// ============================================

model User {
  id           String     @id @default(uuid())
  email        String     @unique @db.VarChar(255)
  passwordHash String     @map("password_hash")
  name         String?
  timezone     String     @default("UTC")
  currency     String     @default("USD") @db.VarChar(3)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  platforms         Platform[]
  earnings          Earning[]
  goals             Goal[]
  products          Product[]
  sales             Sale[]
  inventoryLogs     InventoryLog[]
  customers         Customer[]
  expenses          Expense[]
  invoices          Invoice[]
  webhooks          Webhook[]
  whatsappContacts  WhatsAppContact[]
  whatsappTemplates WhatsAppTemplate[]
  chatConversations ChatConversation[]
  chatConfig        ChatConfig?
  fileUploads       FileUpload[]
  fileFolders       FileFolder[]
  sharedFiles       FileShare[]     @relation("SharedWithUser")
  financialReports  FinancialReport[]
  taxCategories     TaxCategory[]
  financialMetrics  FinancialMetrics[]
  workflows         Workflow[]
  emailTemplates    EmailTemplate[]
  emailSequences    EmailSequence[]
  reports           Report[]
  webauthnCredentials WebAuthnCredential[]
  webauthnChallenges WebAuthnChallenge[]
  helpFeedback      HelpFeedback[]
  integrations      Integration[]
  dashboards        Dashboard[]

  @@map("users")
}

model Platform {
  id           String             @id @default(uuid())
  userId       String             @map("user_id")
  name         String             @db.VarChar(100)
  category     PlatformCategory
  color        String?            @db.VarChar(7) // hex color
  expectedRate Decimal?           @map("expected_rate") @db.Decimal(10, 2)
  isActive     Boolean            @default(true) @map("is_active")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  earnings     Earning[]

  @@unique([userId, name])
  @@index([userId, isActive])
  @@index([userId, createdAt(sort: Desc)])
  @@map("platforms")
}

model Earning {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  platformId String   @map("platform_id")
  date       DateTime @db.Date
  hours      Decimal? @db.Decimal(5, 2)
  amount     Decimal  @db.Decimal(10, 2)
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform   Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@index([userId, date(sort: Desc)])
  @@index([platformId, date(sort: Desc)])
  @@map("earnings")
}

model Goal {
  id            String     @id @default(uuid())
  userId        String     @map("user_id")
  title         String     @db.VarChar(200)
  targetAmount  Decimal    @map("target_amount") @db.Decimal(10, 2)
  currentAmount Decimal    @default(0) @map("current_amount") @db.Decimal(10, 2)
  deadline      DateTime?  @map("deadline") @db.Date
  description   String?    @db.Text
  status        GoalStatus @default(ACTIVE)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@map("goals")
}

model Product {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  price        Decimal  @db.Decimal(10, 2)
  category     String?  @db.VarChar(100)
  sku          String?  @db.VarChar(100) // Stock Keeping Unit

  // Inventory tracking
  quantity     Decimal  @default(0) @db.Decimal(10, 2)
  reorderPoint Decimal  @default(10) @map("reorder_point") @db.Decimal(10, 2)
  supplierName String?  @map("supplier_name") @db.VarChar(255)
  supplierCost Decimal? @map("supplier_cost") @db.Decimal(10, 2)

  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sales        Sale[]
  inventoryLogs InventoryLog[]
  forecasts    InventoryForecast[]
  reorderRules ReorderRule[]
  alerts       InventoryAlert[]

  @@unique([userId, name])
  @@index([userId, isActive])
  @@map("products")
}

model Sale {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  productId    String     @map("product_id")
  quantity     Decimal    @db.Decimal(10, 2)
  unitPrice    Decimal    @map("unit_price") @db.Decimal(10, 2)
  totalAmount  Decimal    @map("total_amount") @db.Decimal(12, 2)
  saleDate     DateTime   @map("sale_date") @db.Date
  customer     String?    @db.VarChar(255)
  notes        String?    @db.Text
  status       SaleStatus @default(COMPLETED)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId, saleDate(sort: Desc)])
  @@index([productId, saleDate(sort: Desc)])
  @@index([userId, status])
  @@index([userId, status, saleDate(sort: Desc)])
  @@map("sales")
}

model InventoryLog {
  id              String             @id @default(uuid())
  userId          String             @map("user_id")
  productId       String             @map("product_id")
  quantityChange  Decimal            @map("quantity_change") @db.Decimal(10, 2)
  type            InventoryLogType
  notes           String?            @db.Text
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([productId, createdAt(sort: Desc)])
  @@map("inventory_logs")
}

model Customer {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  name           String   @db.VarChar(255)
  email          String?  @db.VarChar(255)
  phone          String?  @db.VarChar(20) // E.164 format recommended
  company        String?  @db.VarChar(255)
  address        String?  @db.Text
  city           String?  @db.VarChar(100)
  country        String?  @db.VarChar(100)

  // Customer metrics
  totalPurchases Decimal  @default(0) @map("total_purchases") @db.Decimal(12, 2)
  totalQuantity  Decimal  @default(0) @map("total_quantity") @db.Decimal(10, 2)
  purchaseCount  Int      @default(0) @map("purchase_count")
  lastPurchase   DateTime? @map("last_purchase")

  notes          String?  @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices       Invoice[]

  @@unique([userId, email])
  @@index([userId, isActive])
  @@index([userId, lastPurchase(sort: Desc)])
  @@index([userId, totalPurchases(sort: Desc)])
  @@map("customers")
}

model Expense {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  category        String   @db.VarChar(100)
  description     String   @db.Text
  amount          Decimal  @db.Decimal(10, 2)
  expenseDate     DateTime @map("expense_date") @db.Date

  // Expense details
  vendor          String?  @db.VarChar(255)
  isTaxDeductible Boolean  @default(false) @map("is_tax_deductible")
  receiptUrl      String?  @map("receipt_url") @db.Text

  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expenseDate(sort: Desc)])
  @@index([userId, category])
  @@index([userId, vendor])
  @@index([userId, isTaxDeductible])
  @@map("expenses")
}

model Invoice {
  id             String         @id @default(uuid())
  userId         String         @map("user_id")
  customerId     String?        @map("customer_id")
  invoiceNumber  String         @map("invoice_number") @db.VarChar(100)

  // Invoice details
  subtotal       Decimal        @db.Decimal(12, 2)
  taxAmount      Decimal        @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount Decimal        @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal        @map("total_amount") @db.Decimal(12, 2)

  // Dates
  invoiceDate    DateTime       @map("invoice_date") @db.Date
  dueDate        DateTime       @map("due_date") @db.Date
  paidDate       DateTime?      @map("paid_date") @db.Date

  // Status
  status         InvoiceStatus  @default(DRAFT)
  paymentMethod  PaymentMethod? @map("payment_method")

  notes          String?        @db.Text
  terms          String?        @db.Text

  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer       Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  lineItems      InvoiceLineItem[]

  @@unique([userId, invoiceNumber])
  @@index([userId, invoiceDate(sort: Desc)])
  @@index([userId, status])
  @@index([userId, dueDate(sort: Asc)])
  @@index([userId, status, dueDate])
  @@index([customerId])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String  @id @default(uuid())
  invoiceId   String  @map("invoice_id")
  description String  @db.Text
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal @map("total_price") @db.Decimal(12, 2)

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_line_items")
}

model Webhook {
  id               String         @id @default(uuid())
  userId           String         @map("user_id")
  url              String         @db.Text
  events           String         @db.Text // Comma-separated event types
  secret           String         @db.VarChar(255) // HMAC secret
  status           WebhookStatus  @default(ACTIVE)
  retryCount       Int            @default(0) @map("retry_count")
  lastTriggeredAt  DateTime?      @map("last_triggered_at")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  webhookEvents    WebhookEvent[]
  webhookLogs      WebhookLog[]

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("webhooks")
}

model WebhookEvent {
  id            String            @id @default(uuid())
  webhookId     String            @map("webhook_id")
  eventType     WebhookEventType  @map("event_type")
  payload       String            @db.Text // JSON payload
  statusCode    Int?              @map("status_code")
  attempts      Int               @default(0)
  lastAttemptAt DateTime?         @map("last_attempt_at")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  webhook       Webhook           @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  webhookLogs   WebhookLog[]

  @@index([webhookId, createdAt(sort: Desc)])
  @@index([eventType, createdAt(sort: Desc)])
  @@index([statusCode])
  @@map("webhook_events")
}

model WebhookLog {
  id          String   @id @default(uuid())
  webhookId   String   @map("webhook_id")
  eventId     String   @map("event_id")
  request     String   @db.Text // JSON request
  response    String?  @db.Text // JSON response
  httpStatus  Int      @map("http_status")
  executedAt  DateTime @default(now()) @map("executed_at")

  webhook     Webhook      @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event       WebhookEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([webhookId, executedAt(sort: Desc)])
  @@index([eventId, executedAt(sort: Desc)])
  @@map("webhook_logs")
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

model ChatConversation {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@index([userId, createdAt(sort: Desc)])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           ChatRole
  content        String   @db.Text
  tokensUsed     Int      @default(0) @map("tokens_used")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt(sort: Asc)])
  @@map("chat_messages")
}

model ChatConfig {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  systemPrompt  String   @default("You are a helpful assistant for the EarnTrack platform. Help users track their earnings, manage their business, and provide insights on their financial data.") @map("system_prompt") @db.Text
  modelName     String   @default("gpt-4o-mini") @map("model_name") @db.VarChar(50)
  maxTokens     Int      @default(1000) @map("max_tokens")
  temperature   Float    @default(0.7)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_configs")
}

// ============================================
// WHATSAPP MODELS
// ============================================

model WhatsAppContact {
  id            String                  @id @default(uuid())
  userId        String                  @map("user_id")
  phoneNumber   String                  @map("phone_number") @db.VarChar(20) // E.164 format
  name          String                  @db.VarChar(255)
  status        WhatsAppContactStatus   @default(ACTIVE)
  lastMessageAt DateTime?               @map("last_message_at")
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")

  user          User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      WhatsAppMessage[]

  @@unique([userId, phoneNumber])
  @@index([userId, status])
  @@index([userId, lastMessageAt(sort: Desc)])
  @@map("whatsapp_contacts")
}

model WhatsAppMessage {
  id              String                    @id @default(uuid())
  contactId       String                    @map("contact_id")
  direction       WhatsAppMessageDirection
  messageBody     String                    @map("message_body") @db.Text
  mediaUrl        String?                   @map("media_url") @db.Text
  status          WhatsAppMessageStatus     @default(SENT)
  twilioSid       String?                   @map("twilio_sid") @db.VarChar(255) // Twilio message SID
  timestamp       DateTime                  @default(now())
  createdAt       DateTime                  @default(now()) @map("created_at")
  updatedAt       DateTime                  @updatedAt @map("updated_at")

  contact         WhatsAppContact           @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId, timestamp(sort: Desc)])
  @@index([status])
  @@index([twilioSid])
  @@map("whatsapp_messages")
}

model WhatsAppTemplate {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String   @db.VarChar(255)
  content     String   @db.Text
  variables   String?  @db.Text // JSON array of variable names
  category    String?  @db.VarChar(100)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId, category])
  @@map("whatsapp_templates")
}

// ============================================
// FILE MANAGEMENT MODELS
// ============================================

model FileUpload {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  folderId    String?   @map("folder_id")
  fileName    String    @map("file_name") @db.VarChar(255)
  fileSize    BigInt    @map("file_size") // Size in bytes
  mimeType    String    @map("mime_type") @db.VarChar(100)
  s3Key       String    @map("s3_key") @db.VarChar(500) // S3 object key
  url         String    @db.Text // Public or pre-signed URL
  thumbnailUrl String?  @map("thumbnail_url") @db.Text // For images
  isScanned   Boolean   @default(false) @map("is_scanned") // Virus scan status
  scanResult  String?   @map("scan_result") @db.VarChar(50) // CLEAN, INFECTED, PENDING
  uploadedAt  DateTime  @default(now()) @map("uploaded_at")
  expiresAt   DateTime? @map("expires_at") // Optional expiration
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder      FileFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  shares      FileShare[]

  @@index([userId, uploadedAt(sort: Desc)])
  @@index([folderId, uploadedAt(sort: Desc)])
  @@index([userId, mimeType])
  @@index([scanResult])
  @@map("file_uploads")
}

model FileFolder {
  id             String       @id @default(uuid())
  userId         String       @map("user_id")
  name           String       @db.VarChar(255)
  parentFolderId String?      @map("parent_folder_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentFolder   FileFolder?  @relation("FolderHierarchy", fields: [parentFolderId], references: [id], onDelete: Cascade)
  subFolders     FileFolder[] @relation("FolderHierarchy")
  files          FileUpload[]

  @@unique([userId, parentFolderId, name])
  @@index([userId, createdAt(sort: Desc)])
  @@index([parentFolderId])
  @@map("file_folders")
}

model FileShare {
  id          String               @id @default(uuid())
  fileId      String               @map("file_id")
  sharedBy    String               @map("shared_by") // User ID who shared
  sharedWith  String               @map("shared_with") // User ID or email
  permission  FileSharePermission  @default(VIEW)
  expiresAt   DateTime?            @map("expires_at")
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  file        FileUpload           @relation(fields: [fileId], references: [id], onDelete: Cascade)
  sharedWithUser User?             @relation("SharedWithUser", fields: [sharedWith], references: [id], onDelete: Cascade)

  @@unique([fileId, sharedWith])
  @@index([fileId, createdAt(sort: Desc)])
  @@index([sharedWith, createdAt(sort: Desc)])
  @@map("file_shares")
}

// ============================================
// FINANCIAL REPORTING MODELS
// ============================================

model FinancialReport {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  reportDate   DateTime @map("report_date") @db.Date
  totalRevenue Decimal  @map("total_revenue") @db.Decimal(12, 2)
  totalExpenses Decimal @map("total_expenses") @db.Decimal(12, 2)
  grossProfit  Decimal  @map("gross_profit") @db.Decimal(12, 2)
  netProfit    Decimal  @map("net_profit") @db.Decimal(12, 2)
  taxLiability Decimal  @map("tax_liability") @db.Decimal(12, 2)
  currency     String   @default("USD") @db.VarChar(3)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, reportDate(sort: Desc)])
  @@map("financial_reports")
}

model TaxCategory {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String   @db.VarChar(100)
  percentage  Decimal  @db.Decimal(5, 2)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("tax_categories")
}

model FinancialMetrics {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  period         String   @db.VarChar(50) // e.g., "2024-Q1", "2024-01", "2024-W01"
  profitMargin   Decimal  @map("profit_margin") @db.Decimal(5, 2)
  roi            Decimal  @db.Decimal(5, 2)
  cashFlow       Decimal  @map("cash_flow") @db.Decimal(12, 2)
  debtRatio      Decimal  @map("debt_ratio") @db.Decimal(5, 2)
  assetTurnover  Decimal  @map("asset_turnover") @db.Decimal(5, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period])
  @@index([userId, period(sort: Desc)])
  @@map("financial_metrics")
}

// ============================================
// WORKFLOW AUTOMATION MODELS
// ============================================

enum WorkflowTrigger {
  EARNING_CREATED
  INVOICE_PAID
  LOW_STOCK
  CUSTOMER_CREATED
  GOAL_COMPLETED
}

enum WorkflowExecutionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum EmailStatus {
  SENT
  FAILED
  BOUNCED
}

model Workflow {
  id          String          @id @default(uuid())
  userId      String          @map("user_id")
  name        String          @db.VarChar(255)
  trigger     WorkflowTrigger
  actions     String          @db.Text // JSON array of actions
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions  WorkflowExecution[]

  @@index([userId, isActive])
  @@index([userId, trigger])
  @@index([userId, createdAt(sort: Desc)])
  @@map("workflows")
}

model WorkflowExecution {
  id          String                  @id @default(uuid())
  workflowId  String                  @map("workflow_id")
  status      WorkflowExecutionStatus @default(PENDING)
  executedAt  DateTime                @default(now()) @map("executed_at")
  result      String?                 @db.Text // JSON result
  error       String?                 @db.Text
  createdAt   DateTime                @default(now()) @map("created_at")
  updatedAt   DateTime                @updatedAt @map("updated_at")

  workflow    Workflow                @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, executedAt(sort: Desc)])
  @@index([status, executedAt(sort: Desc)])
  @@map("workflow_executions")
}

model EmailTemplate {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String   @db.VarChar(255)
  subject     String   @db.VarChar(500)
  htmlBody    String   @map("html_body") @db.Text
  variables   String?  @db.Text // JSON array of variable names
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId, createdAt(sort: Desc)])
  @@map("email_templates")
}

model EmailSequence {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String   @db.VarChar(255)
  steps       String   @db.Text // JSON array of sequence steps
  trigger     String   @db.VarChar(100) // Trigger condition
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs        EmailLog[]

  @@unique([userId, name])
  @@index([userId, isActive])
  @@index([userId, createdAt(sort: Desc)])
  @@map("email_sequences")
}

model EmailLog {
  id             String      @id @default(uuid())
  sequenceId     String?     @map("sequence_id")
  recipientEmail String      @map("recipient_email") @db.VarChar(255)
  subject        String      @db.VarChar(500)
  status         EmailStatus @default(SENT)
  sentAt         DateTime    @default(now()) @map("sent_at")
  error          String?     @db.Text
  createdAt      DateTime    @default(now()) @map("created_at")

  sequence       EmailSequence? @relation(fields: [sequenceId], references: [id], onDelete: SetNull)

  @@index([sequenceId, sentAt(sort: Desc)])
  @@index([recipientEmail, sentAt(sort: Desc)])
  @@index([status, sentAt(sort: Desc)])
  @@map("email_logs")
}

// ============================================
// CUSTOM REPORT BUILDER MODELS
// ============================================

enum ReportType {
  EARNINGS
  SALES
  EXPENSES
  FINANCIAL
}

enum ReportFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

model Report {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  name        String       @db.VarChar(255)
  description String?      @db.Text
  reportType  ReportType   @map("report_type")
  columns     String       @db.Text // JSON array of column names
  filters     String       @db.Text // JSON object of filter criteria
  sorting     String       @db.Text // JSON object of sorting configuration
  isPublic    Boolean      @default(false) @map("is_public")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules   ReportSchedule[]
  snapshots   ReportSnapshot[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, reportType])
  @@index([userId, isPublic])
  @@map("reports")
}

model ReportSchedule {
  id        String          @id @default(uuid())
  reportId  String          @map("report_id")
  frequency ReportFrequency
  nextRunAt DateTime        @map("next_run_at")
  isActive  Boolean         @default(true) @map("is_active")
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  report    Report          @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([nextRunAt])
  @@index([isActive, nextRunAt])
  @@map("report_schedules")
}

model ReportSnapshot {
  id          String   @id @default(uuid())
  reportId    String   @map("report_id")
  data        String   @db.Text // JSON snapshot data
  generatedAt DateTime @default(now()) @map("generated_at")

  report      Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, generatedAt(sort: Desc)])
  @@map("report_snapshots")
}

// ============================================
// WEBAUTHN MODELS
// ============================================

model WebAuthnCredential {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  credentialId String   @unique @map("credential_id") @db.Text // base64url encoded
  publicKey    String   @map("public_key") @db.Text // base64url encoded public key
  counter      BigInt   @default(0) // signature counter for replay protection
  transports   String[] // authenticator transports (usb, nfc, ble, internal)
  nickname     String?  @db.VarChar(100) // user-friendly name for the credential
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  lastUsedAt   DateTime? @map("last_used_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([userId, createdAt(sort: Desc)])
  @@map("webauthn_credentials")
}

model WebAuthnChallenge {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id") // Null for registration challenges before user creation
  challenge String   @unique @db.Text // base64url encoded challenge
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)

  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([challenge])
  @@index([userId, createdAt(sort: Desc)])
  @@index([expiresAt])
  @@map("webauthn_challenges")
}

// ============================================
// KNOWLEDGE BASE MODELS
// ============================================

model KnowledgeBaseCategory {
  id           String                 @id @default(uuid())
  name         String                 @db.VarChar(255)
  description  String?                @db.Text
  icon         String?                @db.VarChar(100) // Icon name or emoji
  slug         String                 @unique @db.VarChar(255)
  displayOrder Int                    @default(0) @map("display_order")
  createdAt    DateTime               @default(now()) @map("created_at")
  updatedAt    DateTime               @updatedAt @map("updated_at")

  articles     KnowledgeBaseArticle[]

  @@index([displayOrder(sort: Asc)])
  @@map("knowledge_base_categories")
}

model KnowledgeBaseArticle {
  id          String                 @id @default(uuid())
  categoryId  String                 @map("category_id")
  title       String                 @db.VarChar(500)
  slug        String                 @unique @db.VarChar(500)
  content     String                 @db.Text // Markdown content
  excerpt     String?                @db.VarChar(1000) // Short summary
  author      String?                @db.VarChar(255)
  views       Int                    @default(0)
  helpfulYes  Int                    @default(0) @map("helpful_yes")
  helpfulNo   Int                    @default(0) @map("helpful_no")
  tags        String?                @db.Text // JSON array of tags
  published   Boolean                @default(false)
  publishedAt DateTime?              @map("published_at")
  createdAt   DateTime               @default(now()) @map("created_at")
  updatedAt   DateTime               @updatedAt @map("updated_at")

  category    KnowledgeBaseCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  feedback    HelpFeedback[]
  searchLogs  SearchLog[]

  @@index([categoryId, published])
  @@index([published, publishedAt(sort: Desc)])
  @@index([views(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("knowledge_base_articles")
}

model HelpFeedback {
  id         String               @id @default(uuid())
  userId     String               @map("user_id")
  articleId  String               @map("article_id")
  isHelpful  Boolean              @map("is_helpful")
  rating     Int?                 // 1-5 star rating
  comment    String?              @db.Text
  createdAt  DateTime             @default(now()) @map("created_at")
  updatedAt  DateTime             @updatedAt @map("updated_at")

  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  article    KnowledgeBaseArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([articleId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("help_feedback")
}

model SearchLog {
  id          String                @id @default(uuid())
  userId      String?               @map("user_id") // Nullable to track anonymous searches
  articleId   String?               @map("article_id") // Article clicked from search
  query       String                @db.VarChar(500)
  resultCount Int                   @default(0) @map("result_count")
  createdAt   DateTime              @default(now()) @map("created_at")

  article     KnowledgeBaseArticle? @relation(fields: [articleId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt(sort: Desc)])
  @@index([query])
  @@index([createdAt(sort: Desc)])
  @@map("search_logs")
}

// ============================================
// INTEGRATION MODELS (Zapier/Make/Slack/Teams)
// ============================================

model Integration {
  id        String               @id @default(uuid())
  userId    String               @map("user_id")
  platform  IntegrationPlatform
  apiKey    String               @map("api_key") @db.VarChar(500) // Encrypted API key or OAuth token
  webhookUrl String?             @map("webhook_url") @db.Text // Webhook URL for the integration
  isActive  Boolean              @default(true) @map("is_active")
  lastSync  DateTime?            @map("last_sync")

  // OAuth specific fields
  accessToken  String?           @map("access_token") @db.Text
  refreshToken String?           @map("refresh_token") @db.Text
  tokenExpiry  DateTime?         @map("token_expiry")

  // Configuration
  config    String?              @db.Text // JSON configuration for platform-specific settings

  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncLogs  SyncLog[]

  @@unique([userId, platform])
  @@index([userId, isActive])
  @@index([userId, platform])
  @@map("integrations")
}

model SyncLog {
  id            String     @id @default(uuid())
  integrationId String     @map("integration_id")
  action        String     @db.VarChar(255) // e.g., "CREATE_EARNING", "CREATE_INVOICE", "SYNC_CUSTOMERS"
  status        SyncStatus @default(PENDING)
  recordCount   Int        @default(0) @map("record_count")
  error         String?    @db.Text
  requestData   String?    @map("request_data") @db.Text // JSON request data
  responseData  String?    @map("response_data") @db.Text // JSON response data
  executedAt    DateTime   @default(now()) @map("executed_at")

  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, executedAt(sort: Desc)])
  @@index([status, executedAt(sort: Desc)])
  @@index([integrationId, status])
  @@map("sync_logs")
}

// ============================================
// CUSTOM DASHBOARD MODELS
// ============================================

enum WidgetType {
  CHART
  KPI
  TABLE
  TEXT
  GAUGE
  HEATMAP
  TIME_SERIES
}

model Dashboard {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String   @db.VarChar(255)
  layout    String   @db.Text // JSON layout configuration
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  widgets   DashboardWidget[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, isDefault])
  @@map("dashboards")
}

model DashboardWidget {
  id              String     @id @default(uuid())
  dashboardId     String     @map("dashboard_id")
  type            WidgetType
  title           String     @db.VarChar(255)
  config          String     @db.Text // JSON widget configuration
  positionX       Int        @map("position_x")
  positionY       Int        @map("position_y")
  sizeW           Int        @map("size_w")
  sizeH           Int        @map("size_h")
  dataSource      String     @map("data_source") @db.VarChar(255) // e.g., "earnings", "sales", "expenses"
  refreshInterval Int?       @map("refresh_interval") // Refresh interval in seconds
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  dashboard       Dashboard  @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@map("dashboard_widgets")
}

model WidgetTemplate {
  id          String     @id @default(uuid())
  name        String     @db.VarChar(255)
  type        WidgetType
  icon        String     @db.VarChar(100)
  description String?    @db.Text
  config      String     @db.Text // JSON default configuration
  category    String     @db.VarChar(100) // e.g., "Analytics", "Sales", "Finance"
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@index([type])
  @@index([category])
  @@map("widget_templates")
}

// ============================================
// SMART INVENTORY MODELS
// ============================================

model InventoryForecast {
  id             String         @id @default(uuid())
  productId      String         @map("product_id")
  forecastedDate DateTime       @map("forecasted_date") @db.Date
  quantity       Decimal        @db.Decimal(10, 2)
  confidence     Decimal        @db.Decimal(5, 2) // Percentage (0-100)
  method         ForecastMethod
  createdAt      DateTime       @default(now()) @map("created_at")

  product        Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, forecastedDate(sort: Asc)])
  @@index([productId, createdAt(sort: Desc)])
  @@map("inventory_forecasts")
}

model ReorderRule {
  id         String   @id @default(uuid())
  productId  String   @map("product_id")
  minStock   Decimal  @map("min_stock") @db.Decimal(10, 2)
  maxStock   Decimal  @map("max_stock") @db.Decimal(10, 2)
  reorderQty Decimal  @map("reorder_qty") @db.Decimal(10, 2)
  leadTime   Int      @map("lead_time") // Lead time in days
  supplier   String?  @db.VarChar(255)
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId])
  @@index([productId, isActive])
  @@index([isActive, createdAt(sort: Desc)])
  @@map("reorder_rules")
}

model InventoryAlert {
  id         String    @id @default(uuid())
  productId  String    @map("product_id")
  type       AlertType
  message    String    @db.Text
  triggered  DateTime  @default(now())
  resolvedAt DateTime? @map("resolved_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, triggered(sort: Desc)])
  @@index([type, triggered(sort: Desc)])
  @@index([resolvedAt])
  @@map("inventory_alerts")
}

// ============================================
// BILLING AND SUBSCRIPTION MODELS
// ============================================

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  SUSPENDED
  TRIALING
  PAST_DUE
}

enum PaymentMethodType {
  CARD
  BANK
  PAYPAL
}

enum BillingStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

model PricingPlan {
  id            String        @id @default(uuid())
  name          String        @db.VarChar(255)
  description   String?       @db.Text
  price         Decimal       @db.Decimal(10, 2)
  billingCycle  BillingCycle  @map("billing_cycle")
  features      String        @db.Text
  isActive      Boolean       @default(true) @map("is_active")
  trialDays     Int           @default(0) @map("trial_days")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@index([isActive, billingCycle])
  @@map("pricing_plans")
}

model Subscription {
  id               String             @id @default(uuid())
  userId           String             @map("user_id")
  planId           String             @map("plan_id")
  status           SubscriptionStatus @default(TRIALING)
  startDate        DateTime           @map("start_date") @db.Date
  currentPeriodEnd DateTime           @map("current_period_end") @db.Date
  trialEndsAt      DateTime?          @map("trial_ends_at") @db.Date
  cancelledAt      DateTime?          @map("cancelled_at")
  cancelAtPeriodEnd Boolean           @default(false) @map("cancel_at_period_end")
  metadata         String?            @db.Text
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan             PricingPlan        @relation(fields: [planId], references: [id], onDelete: Restrict)
  billingHistory   BillingHistory[]
  invoices         Invoice[]          @relation("SubscriptionInvoices")

  @@index([userId, status])
  @@index([status, currentPeriodEnd])
  @@index([planId, status])
  @@map("subscriptions")
}

model BillingHistory {
  id             String        @id @default(uuid())
  subscriptionId String        @map("subscription_id")
  invoiceId      String?       @map("invoice_id")
  amount         Decimal       @db.Decimal(10, 2)
  billedDate     DateTime      @map("billed_date") @db.Date
  dueDate        DateTime      @map("due_date") @db.Date
  paidDate       DateTime?     @map("paid_date") @db.Date
  status         BillingStatus @default(PENDING)
  retryCount     Int           @default(0) @map("retry_count")
  nextRetryAt    DateTime?     @map("next_retry_at")
  failureReason  String?       @map("failure_reason") @db.Text
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  subscription   Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  invoice        Invoice?      @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([subscriptionId, billedDate(sort: Desc)])
  @@index([status, dueDate])
  @@index([status, nextRetryAt])
  @@map("billing_history")
}

model PaymentMethodModel {
  id        String            @id @default(uuid())
  userId    String            @map("user_id")
  type      PaymentMethodType
  token     String            @db.VarChar(500)
  last4     String?           @db.VarChar(4)
  brand     String?           @db.VarChar(50)
  expiresAt DateTime?         @map("expires_at")
  isDefault Boolean           @default(false) @map("is_default")
  isActive  Boolean           @default(true) @map("is_active")
  metadata  String?           @db.Text
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isDefault])
  @@index([userId, isActive])
  @@map("payment_methods")
}
