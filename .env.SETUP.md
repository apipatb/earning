# Environment Variables Setup Guide

This guide will help you configure all environment variables for the EarnTrack application. The application is designed to work with minimal configuration, and most services are optional.

## Table of Contents

- [Quick Start](#quick-start)
- [Required Configuration](#required-configuration)
- [Optional Services](#optional-services)
  - [Sentry - Error Tracking](#sentry-error-tracking)
  - [OpenAI - AI Chatbot](#openai-ai-chatbot)
  - [Twilio - SMS & WhatsApp](#twilio-sms--whatsapp)
  - [Elasticsearch - Advanced Search](#elasticsearch-advanced-search)
  - [AWS S3 - File Storage](#aws-s3-file-storage)
  - [Email - SMTP Configuration](#email-smtp-configuration)
  - [WebAuthn - Passwordless Authentication](#webauthn-passwordless-authentication)
- [Security Best Practices](#security-best-practices)
- [Development vs Production](#development-vs-production)
- [Troubleshooting](#troubleshooting)

---

## Quick Start

### Minimal Setup (Local Development)

To get started quickly with just the core features:

1. **Copy the example file:**
   ```bash
   cp .env.example .env
   ```

2. **Update required values:**
   - `POSTGRES_PASSWORD` - Choose a secure password
   - `JWT_SECRET` - Generate with: `openssl rand -base64 32`
   - `DATABASE_URL` - Update password in connection string

3. **Start the application:**
   ```bash
   docker-compose up -d
   ```

That's it! The application will run with core features. Optional services can be added later.

---

## Required Configuration

### 1. Database (PostgreSQL)

**Required for:** All features

**Environment Variables:**
```bash
POSTGRES_USER=earntrack
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_DB=earntrack
POSTGRES_PORT=5432
DATABASE_URL="postgresql://earntrack:your_secure_password_here@localhost:5432/earntrack?schema=public"
```

**Setup:**
- For Docker: These values are automatically configured
- For local PostgreSQL: Update `DATABASE_URL` with your credentials

**Security Notes:**
- Never use default passwords in production
- Use a password manager to generate strong passwords (20+ characters)
- Keep database backups in a secure location

---

### 2. JWT Authentication

**Required for:** User authentication and session management

**Environment Variables:**
```bash
JWT_SECRET=your_long_random_secret_key_here
JWT_EXPIRES_IN=7d
```

**Setup:**
Generate a secure random secret:
```bash
# Linux/Mac:
openssl rand -base64 32

# Node.js:
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# Online: https://www.random.org/strings/ (256-bit alphanumeric)
```

**Security Notes:**
- NEVER commit JWT_SECRET to version control
- Use different secrets for development and production
- If compromised, change immediately (will invalidate all sessions)
- Minimum 32 characters recommended

---

### 3. CORS Configuration

**Required for:** Frontend-backend communication

**Environment Variables:**
```bash
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,http://localhost:80
```

**Setup:**
- Development: Include all local development ports
- Production: Update with your production domain
  ```bash
  ALLOWED_ORIGINS=https://yourapp.com,https://www.yourapp.com
  ```

---

## Optional Services

### Sentry Error Tracking

**What it does:** Monitors errors, crashes, and performance issues in production

**Required:** NO - App works without it
**Cost:** Free tier (5k events/month), Paid plans from $26/month
**Recommended for:** Production deployments

#### Setup Steps:

1. **Create Sentry Account:**
   - Go to [https://sentry.io](https://sentry.io)
   - Sign up for free account

2. **Create Project:**
   - Click "Create Project"
   - Select platform: **Node.js**
   - Select framework: **Express**
   - Name your project (e.g., "EarnTrack Backend")
   - Click "Create Project"

3. **Get DSN:**
   - After creating project, you'll see setup instructions
   - Copy the DSN (looks like: `https://abc123@o123456.ingest.sentry.io/123456`)
   - Or find it later: Settings → Projects → [Your Project] → Client Keys (DSN)

4. **Configure Environment:**
   ```bash
   SENTRY_DSN=https://your_key@your_org.ingest.sentry.io/your_project
   SENTRY_ENVIRONMENT=production
   SENTRY_TRACE_SAMPLE_RATE=0.1  # 10% of transactions
   ENABLE_ERROR_TRACKING=true
   ```

5. **Optional Settings:**
   - Set up Alerts: Settings → Alerts
   - Configure Releases: Link to your CI/CD
   - Add Source Maps: For better stack traces

#### Documentation:
- [Sentry Node.js Docs](https://docs.sentry.io/platforms/node/)
- [Sentry Express Integration](https://docs.sentry.io/platforms/node/guides/express/)

---

### OpenAI AI Chatbot

**What it does:** Powers the AI assistant for earning insights and recommendations

**Required:** NO - Chatbot feature disabled without it
**Cost:** Pay-per-use (~$0.15 per 1M tokens for gpt-4o-mini)
**Recommended for:** Production if you want AI features

#### Setup Steps:

1. **Create OpenAI Account:**
   - Go to [https://platform.openai.com](https://platform.openai.com)
   - Sign up for account
   - Add payment method (required for API access)

2. **Generate API Key:**
   - Go to [https://platform.openai.com/api-keys](https://platform.openai.com/api-keys)
   - Click "Create new secret key"
   - Name it (e.g., "EarnTrack Production")
   - Copy the key (starts with `sk-...`)
   - **IMPORTANT:** Save it now - you can't view it again!

3. **Set Usage Limits (Recommended):**
   - Go to Settings → Organization → Limits
   - Set monthly budget cap (e.g., $20/month)
   - Set email notifications for usage alerts

4. **Configure Environment:**
   ```bash
   OPENAI_API_KEY=sk-your_api_key_here
   OPENAI_MODEL_NAME=gpt-4o-mini
   OPENAI_MAX_TOKENS=1000
   ```

5. **Choose Model:**
   - `gpt-4o-mini` - Fastest, cheapest, good quality (recommended)
   - `gpt-4o` - Higher quality, more expensive
   - `gpt-4-turbo` - Balance of speed and quality

#### Cost Estimation:
- Average conversation: ~500-2000 tokens
- gpt-4o-mini: $0.15 per 1M tokens
- 10,000 conversations/month ≈ $1.50/month

#### Documentation:
- [OpenAI API Keys](https://platform.openai.com/api-keys)
- [OpenAI Pricing](https://openai.com/pricing)
- [Chat API Documentation](https://platform.openai.com/docs/guides/chat)

---

### Twilio SMS & WhatsApp

**What it does:** Send SMS campaigns and WhatsApp messages to customers

**Required:** NO - SMS/WhatsApp features disabled without it
**Cost:** Pay-per-message (~$0.0075 per SMS in US)
**Recommended for:** Production if you need messaging features

#### Setup Steps:

1. **Create Twilio Account:**
   - Go to [https://www.twilio.com/try-twilio](https://www.twilio.com/try-twilio)
   - Sign up for free account
   - Get $15 free trial credits (US only)
   - Verify your phone number

2. **Get Account Credentials:**
   - Log in to [Twilio Console](https://console.twilio.com)
   - From Dashboard, copy:
     - **Account SID** (starts with `AC...`)
     - **Auth Token** (click to reveal)

3. **Purchase Phone Number:**
   - Go to Phone Numbers → Manage → Buy a number
   - Search by country/area code
   - Select capabilities: **SMS** and/or **Voice**
   - Purchase number (free with trial credits)
   - Copy phone number (format: +14155552671)

4. **Configure Environment:**
   ```bash
   TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   TWILIO_AUTH_TOKEN=your_auth_token_here
   TWILIO_PHONE_NUMBER=+14155552671
   ```

5. **WhatsApp Setup (Optional):**
   - Request WhatsApp access in Twilio Console
   - Complete Facebook Business verification
   - Create WhatsApp message templates
   - Wait for approval (1-3 business days)

6. **Set Up Webhooks (Optional):**
   For receiving SMS/WhatsApp messages:
   - Go to Phone Numbers → Manage → Active Numbers
   - Click your number
   - Under Messaging, configure webhooks:
     - URL: `https://yourapp.com/api/v1/webhooks/twilio/sms`
     - Method: POST

#### Cost Estimation:
- SMS (US): $0.0075 per message
- WhatsApp: $0.005-0.025 per message (varies by country)
- Phone number: $1.15/month
- 1,000 SMS/month ≈ $8.65/month

#### Documentation:
- [Twilio Console](https://console.twilio.com)
- [Twilio Pricing](https://www.twilio.com/pricing)
- [SMS API Docs](https://www.twilio.com/docs/sms)
- [WhatsApp API Docs](https://www.twilio.com/docs/whatsapp)

---

### Elasticsearch Advanced Search

**What it does:** Full-text search across tickets, messages, customers, documents

**Required:** NO - Basic database search works without it
**Cost:** Free (self-hosted) or $95+/month (Elastic Cloud)
**Recommended for:** Production with >10k records or complex search needs

#### Option 1: Elastic Cloud (Recommended for Production)

1. **Create Account:**
   - Go to [https://cloud.elastic.co](https://cloud.elastic.co)
   - Sign up for free account
   - Start 14-day free trial

2. **Create Deployment:**
   - Click "Create deployment"
   - Choose cloud provider and region
   - Select size (start small, scale later)
   - Wait for deployment (2-5 minutes)

3. **Get Credentials:**
   - Copy the **Cloud ID**
   - Copy the **Elastic endpoint** URL
   - Create API key:
     - Go to Management → Stack Management → Security → API Keys
     - Click "Create API key"
     - Name it (e.g., "EarnTrack Backend")
     - Copy the API key

4. **Configure Environment:**
   ```bash
   ELASTICSEARCH_NODE=https://your-deployment.es.us-east-1.aws.found.io:9243
   ELASTICSEARCH_API_KEY=your_api_key_here
   ```

#### Option 2: Self-Hosted (Development)

1. **Using Docker (Easiest):**
   ```bash
   docker run -d \
     --name elasticsearch \
     -p 9200:9200 \
     -e "discovery.type=single-node" \
     -e "xpack.security.enabled=false" \
     docker.elastic.co/elasticsearch/elasticsearch:8.11.0
   ```

2. **Configure Environment:**
   ```bash
   ELASTICSEARCH_NODE=http://localhost:9200
   # No authentication needed for development
   ```

3. **Verify Installation:**
   ```bash
   curl http://localhost:9200
   # Should return cluster info JSON
   ```

#### Option 3: Download and Install

1. **Download:**
   - Go to [https://www.elastic.co/downloads/elasticsearch](https://www.elastic.co/downloads/elasticsearch)
   - Choose your OS
   - Download and extract

2. **Start Elasticsearch:**
   ```bash
   # Linux/Mac:
   ./bin/elasticsearch

   # Windows:
   bin\elasticsearch.bat
   ```

3. **Configure Environment:**
   ```bash
   ELASTICSEARCH_NODE=http://localhost:9200
   ELASTICSEARCH_USERNAME=elastic
   ELASTICSEARCH_PASSWORD=your_password
   ```

#### Documentation:
- [Elastic Cloud](https://cloud.elastic.co)
- [Elasticsearch Installation](https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html)
- [Elasticsearch Pricing](https://www.elastic.co/pricing/)

---

### AWS S3 File Storage

**What it does:** Store user uploads, attachments, documents, backups

**Required:** NO - File upload features disabled without it
**Cost:** First 5GB free, then ~$0.023/GB/month
**Recommended for:** Production deployments

#### Setup Steps:

1. **Create AWS Account:**
   - Go to [https://aws.amazon.com](https://aws.amazon.com)
   - Sign up for free tier account
   - Add payment method (required)

2. **Create IAM User:**
   - Go to IAM → Users → Create User
   - Username: `earntrack-s3-user`
   - Access type: **Programmatic access** (API)
   - Click Next

3. **Set Permissions:**
   - Attach existing policies: **AmazonS3FullAccess**
   - Or create custom policy (recommended):
     ```json
     {
       "Version": "2012-10-17",
       "Statement": [
         {
           "Effect": "Allow",
           "Action": [
             "s3:PutObject",
             "s3:GetObject",
             "s3:DeleteObject",
             "s3:ListBucket"
           ],
           "Resource": [
             "arn:aws:s3:::your-bucket-name",
             "arn:aws:s3:::your-bucket-name/*"
           ]
         }
       ]
     }
     ```
   - Click Next → Create User

4. **Save Credentials:**
   - **Access Key ID** (starts with `AKIA...`)
   - **Secret Access Key** (only shown once!)
   - Download CSV or copy to secure location

5. **Create S3 Bucket:**
   - Go to S3 → Create bucket
   - Bucket name: `earntrack-files-production` (must be globally unique)
   - Region: Choose closest to your users
   - Block Public Access: **Keep enabled** (recommended)
   - Versioning: Optional (recommended for backups)
   - Encryption: Enable (recommended)
   - Click Create

6. **Configure CORS (if needed):**
   - Click bucket → Permissions → CORS
   - Add CORS policy:
     ```json
     [
       {
         "AllowedHeaders": ["*"],
         "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
         "AllowedOrigins": ["https://yourapp.com"],
         "ExposeHeaders": ["ETag"]
       }
     ]
     ```

7. **Configure Environment:**
   ```bash
   AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
   AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
   AWS_S3_BUCKET=earntrack-files-production
   AWS_REGION=us-east-1
   ```

#### Security Best Practices:
- Never commit AWS credentials to git
- Use IAM policies to restrict bucket access
- Enable bucket encryption
- Use pre-signed URLs instead of public access
- Enable CloudTrail for audit logs
- Set up bucket lifecycle policies to manage costs

#### Cost Estimation:
- Storage: $0.023/GB/month
- Requests: $0.0004 per 1000 GET requests
- Data transfer: First 1GB free, then $0.09/GB
- 10GB storage + 10k requests ≈ $0.23/month

#### Documentation:
- [AWS S3 Console](https://s3.console.aws.amazon.com)
- [S3 User Guide](https://docs.aws.amazon.com/s3/)
- [IAM Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [S3 Pricing](https://aws.amazon.com/s3/pricing/)

---

### Email SMTP Configuration

**What it does:** Send password resets, notifications, alerts to users

**Required:** NO - App works without email
**Cost:** Free tier available with most providers
**Recommended for:** Production deployments

#### Option 1: Gmail (Development Only)

**Not recommended for production - use a proper email service**

1. **Enable 2FA:**
   - Go to [https://myaccount.google.com/security](https://myaccount.google.com/security)
   - Enable 2-Step Verification

2. **Create App Password:**
   - Go to [https://myaccount.google.com/apppasswords](https://myaccount.google.com/apppasswords)
   - Select app: Mail
   - Select device: Other (Custom name)
   - Name it: "EarnTrack"
   - Copy the 16-character password

3. **Configure Environment:**
   ```bash
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=your.email@gmail.com
   SMTP_PASSWORD=your_16_char_app_password
   EMAIL_FROM=your.email@gmail.com
   ```

4. **Limitations:**
   - Gmail limits: 500 emails/day
   - May be marked as spam
   - Not suitable for production

#### Option 2: SendGrid (Recommended)

1. **Create Account:**
   - Go to [https://sendgrid.com](https://sendgrid.com)
   - Sign up for free account
   - Free tier: 100 emails/day forever

2. **Verify Sender:**
   - Go to Settings → Sender Authentication
   - Verify single sender email OR
   - Authenticate domain (recommended for production)

3. **Create API Key:**
   - Go to Settings → API Keys
   - Click "Create API Key"
   - Name: "EarnTrack Production"
   - Permissions: Full Access (or Mail Send only)
   - Copy the API key

4. **Configure Environment:**
   ```bash
   SMTP_HOST=smtp.sendgrid.net
   SMTP_PORT=587
   SMTP_USER=apikey
   SMTP_PASSWORD=SG.your_api_key_here
   EMAIL_FROM=noreply@yourdomain.com
   ```

#### Option 3: AWS SES (Cost-Effective)

1. **Setup:**
   - Go to AWS Console → SES
   - Verify email address or domain
   - Request production access (out of sandbox)
   - Get SMTP credentials

2. **Configure Environment:**
   ```bash
   SMTP_HOST=email-smtp.us-east-1.amazonaws.com
   SMTP_PORT=587
   SMTP_USER=your_smtp_username
   SMTP_PASSWORD=your_smtp_password
   EMAIL_FROM=noreply@yourdomain.com
   ```

3. **Cost:** $0.10 per 1000 emails

#### Option 4: Mailgun

1. **Create Account:**
   - Go to [https://www.mailgun.com](https://www.mailgun.com)
   - Sign up for free account
   - Free tier: 5,000 emails/month

2. **Get Credentials:**
   - Go to Sending → Domain settings
   - Copy SMTP credentials

3. **Configure Environment:**
   ```bash
   SMTP_HOST=smtp.mailgun.org
   SMTP_PORT=587
   SMTP_USER=postmaster@your-domain.mailgun.org
   SMTP_PASSWORD=your_smtp_password
   EMAIL_FROM=noreply@your-domain.mailgun.org
   ```

#### Provider Comparison:

| Provider | Free Tier | Cost | Best For |
|----------|-----------|------|----------|
| Gmail | 500/day | Free | Development only |
| SendGrid | 100/day | $0 (free tier)<br>$19.95/mo (40k/mo) | Small-medium apps |
| AWS SES | 62k/month (if on EC2) | $0.10/1000 | High volume |
| Mailgun | 5k/month | $0 (free tier)<br>$35/mo (50k/mo) | Medium apps |
| Postmark | 100/month | $15/mo (10k/mo) | Transactional emails |

#### Documentation:
- [SendGrid Docs](https://docs.sendgrid.com)
- [AWS SES Docs](https://docs.aws.amazon.com/ses/)
- [Mailgun Docs](https://documentation.mailgun.com)

---

### WebAuthn Passwordless Authentication

**What it does:** Biometric authentication (Face ID, Touch ID, Windows Hello, security keys)

**Required:** NO - Standard password auth works without it
**Cost:** Free
**Recommended for:** Enhanced security

#### Setup Steps:

1. **Development Configuration:**
   ```bash
   WEBAUTHN_RP_NAME=EarnTrack
   WEBAUTHN_RP_ID=localhost
   WEBAUTHN_ORIGIN=http://localhost:3000
   ```

2. **Production Configuration:**
   ```bash
   WEBAUTHN_RP_NAME=EarnTrack Production
   WEBAUTHN_RP_ID=earntrack.app
   WEBAUTHN_ORIGIN=https://earntrack.app
   ```

3. **Important Notes:**
   - `RP_ID` must match your domain (without protocol/port)
   - `ORIGIN` must match exactly (including protocol and port)
   - HTTPS required in production (except localhost)
   - Works with:
     - Face ID / Touch ID (iOS/Mac)
     - Windows Hello (Windows)
     - Android biometric
     - Hardware security keys (YubiKey, etc.)

4. **Testing:**
   - Use a device with biometric capabilities
   - Or use a hardware security key
   - Localhost works over HTTP for testing

#### Documentation:
- [WebAuthn Guide](https://webauthn.guide/)
- [MDN WebAuthn API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API)

---

## Security Best Practices

### Never Commit Secrets

1. **Add to .gitignore:**
   ```bash
   .env
   .env.local
   .env.production
   ```

2. **Check before committing:**
   ```bash
   git diff
   git status
   ```

3. **If you accidentally commit secrets:**
   ```bash
   # Immediately rotate the compromised credentials
   # Remove from git history:
   git filter-branch --force --index-filter \
     "git rm --cached --ignore-unmatch .env" \
     --prune-empty --tag-name-filter cat -- --all
   ```

### Use Environment-Specific Files

```bash
# Development
.env.development

# Staging
.env.staging

# Production
.env.production
```

### Rotate Credentials Regularly

- JWT secrets: Every 6 months
- API keys: Yearly or when team members leave
- Database passwords: Yearly
- Check for compromised credentials: [Have I Been Pwned](https://haveibeenpwned.com/)

### Use Secret Management Tools

**For Production:**
- AWS Secrets Manager
- HashiCorp Vault
- Azure Key Vault
- Google Secret Manager

**For Teams:**
- 1Password Teams
- Bitwarden
- LastPass Enterprise

---

## Development vs Production

### Development Setup

**Minimal configuration for local development:**

```bash
# Required only
DATABASE_URL=postgresql://earntrack:dev@localhost:5432/earntrack
JWT_SECRET=dev-secret-do-not-use-in-production
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000

# Optional - add as needed
SENTRY_DSN=  # Skip for development
OPENAI_API_KEY=  # Add if testing AI features
TWILIO_ACCOUNT_SID=  # Add if testing SMS
```

### Production Checklist

- [ ] Strong PostgreSQL password
- [ ] Secure JWT secret (32+ characters)
- [ ] Production domain in ALLOWED_ORIGINS
- [ ] Sentry DSN configured
- [ ] HTTPS enabled
- [ ] Environment variables in secure storage
- [ ] Regular backups configured
- [ ] Monitoring and alerts set up
- [ ] Rate limiting configured
- [ ] CORS properly configured
- [ ] Production email service (SendGrid/SES)
- [ ] S3 bucket with proper IAM policies
- [ ] WebAuthn configured for production domain

---

## Troubleshooting

### Common Issues

#### "Database connection failed"
- Check DATABASE_URL format
- Verify PostgreSQL is running
- Check password doesn't contain special characters (URL encode if needed)
- Verify network access (firewall, security groups)

#### "JWT secret not set"
- Ensure JWT_SECRET is set in .env
- Check .env file is in correct directory
- Verify .env is being loaded (not .env.example)

#### "CORS error"
- Add frontend URL to ALLOWED_ORIGINS
- Include protocol and port exactly
- No trailing slash in URLs
- Check CORS_CREDENTIALS setting

#### "OpenAI API error"
- Verify API key starts with `sk-`
- Check billing/usage limits in OpenAI dashboard
- Ensure sufficient credits/payment method
- Check model name is correct

#### "Twilio authentication failed"
- Verify Account SID starts with `AC`
- Check Auth Token is correct (no spaces)
- Ensure phone number is in E.164 format (+1234567890)

#### "S3 access denied"
- Verify IAM user has S3 permissions
- Check bucket name is correct
- Verify region matches bucket location
- Check bucket policy and ACLs

#### "Elasticsearch connection failed"
- Verify Elasticsearch is running
- Check node URL (http:// or https://)
- Test connection: `curl http://localhost:9200`
- Verify authentication credentials

### Getting Help

- Check application logs: `docker-compose logs backend`
- Enable debug logging: `LOG_LEVEL=debug`
- Review error messages in Sentry (if configured)
- Search GitHub issues: [Your Repository Issues]
- Community Discord/Slack: [Link if available]

---

## Quick Setup Checklist

### Minimum Viable Setup (5 minutes)

- [ ] Copy .env.example to .env
- [ ] Set POSTGRES_PASSWORD
- [ ] Generate and set JWT_SECRET
- [ ] Update DATABASE_URL password
- [ ] Run `docker-compose up -d`

### Recommended Setup (30 minutes)

- [ ] All minimum setup items
- [ ] Configure Sentry for error tracking
- [ ] Set up email (SendGrid/AWS SES)
- [ ] Configure S3 for file uploads
- [ ] Set up proper CORS for production domain

### Full Production Setup (2-4 hours)

- [ ] All recommended setup items
- [ ] Configure OpenAI for AI features
- [ ] Set up Twilio for SMS/WhatsApp
- [ ] Configure Elasticsearch for advanced search
- [ ] Enable WebAuthn for passwordless auth
- [ ] Set up monitoring and alerts
- [ ] Configure backups
- [ ] Security audit
- [ ] Performance testing

---

## Support

For issues or questions:
- GitHub Issues: [Your Repository]
- Documentation: [Your Docs Site]
- Email: support@earntrack.app
- Community: [Discord/Slack Link]

---

**Last Updated:** 2025-11-16
**Version:** 1.0.0
