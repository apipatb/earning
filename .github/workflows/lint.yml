name: Lint

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci
        working-directory: /home/user/earning
        continue-on-error: true

      - name: Install backend dependencies
        run: npm ci
        working-directory: app/backend

      - name: Install frontend dependencies
        run: npm ci
        working-directory: app/frontend

      - name: Setup ESLint for backend
        run: |
          if [ ! -f .eslintrc.json ] && [ ! -f .eslintrc.js ] && [ ! -f eslint.config.js ]; then
            echo "No ESLint config found in backend, creating default..."
            cat > .eslintrc.json << 'EOF'
          {
            "root": true,
            "parser": "@typescript-eslint/parser",
            "parserOptions": {
              "ecmaVersion": 2020,
              "sourceType": "module"
            },
            "extends": [
              "eslint:recommended",
              "plugin:@typescript-eslint/recommended"
            ],
            "env": {
              "node": true,
              "es2020": true,
              "jest": true
            },
            "rules": {
              "@typescript-eslint/no-unused-vars": ["warn", { "argsIgnorePattern": "^_" }],
              "@typescript-eslint/explicit-module-boundary-types": "off",
              "no-console": "warn"
            }
          }
          EOF
          fi
        working-directory: app/backend
        continue-on-error: true

      - name: Lint backend with ESLint
        run: |
          if npm ls eslint > /dev/null 2>&1; then
            npx eslint src --ext ts,tsx --format json --output-file eslint-report.json 2>/dev/null || true
            npx eslint src --ext ts,tsx --format stylish 2>&1 | tee eslint-output.txt || true
          else
            echo "ESLint not installed in backend, skipping backend linting"
          fi
        working-directory: app/backend
        continue-on-error: true

      - name: Lint frontend with ESLint
        run: npm run lint -- --format stylish --max-warnings=10
        working-directory: app/frontend
        continue-on-error: false

      - name: Check for critical linting errors
        run: |
          BACKEND_ERRORS=0
          if [ -f app/backend/eslint-output.txt ]; then
            BACKEND_ERRORS=$(grep -c "error" app/backend/eslint-output.txt || true)
          fi

          FRONTEND_ERRORS=$(cd app/frontend && npx eslint src --ext ts,tsx --format compact 2>&1 | grep -c "error" || true)

          echo "Backend linting errors: $BACKEND_ERRORS"
          echo "Frontend linting errors: $FRONTEND_ERRORS"

          TOTAL_ERRORS=$((BACKEND_ERRORS + FRONTEND_ERRORS))

          if [ $TOTAL_ERRORS -gt 0 ]; then
            echo "❌ Critical linting errors found: $TOTAL_ERRORS"
            exit 1
          else
            echo "✓ No critical linting errors found"
          fi
        continue-on-error: false

      - name: Linting Report
        if: always()
        run: |
          echo "## Linting Results"
          echo "✓ Backend ESLint check completed"
          echo "✓ Frontend ESLint validation passed"
          echo "✓ Code quality checks completed"
